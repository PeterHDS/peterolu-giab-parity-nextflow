// =====================
// nextflow.config
// =====================

// ---- Default parameters (local dev) ----
params.reads           = "../assets/reads/demo_R{1,2}.fastq.gz"
params.reference_fasta = "../assets/ref/miniref.fa"
params.truth_vcf       = "../assets/giab/chrMock_truth.vcf.gz"
params.confident_bed   = "../assets/giab/chrMock_confident.bed"
params.outdir          = "./results"

// ---- Global process defaults ----
process {
  executor = 'local'
  cpus     = 1
  memory   = '1 GB'
}

// ---- Profiles ----
profiles {

  //
  // Local dev: everything on the laptop
  //
  local {
    process {
      executor = 'local'
      cpus     = 1
      memory   = '1 GB'
    }
  }

  //
  // AWS Batch Fargate profile
  //
  awsbatch_fg {

    //
    // S3 workDir + outdir, driven by env vars where possible
    //
    workDir = "s3://${System.getenv('PP_NF_WORK_BUCKET') ?: 'pp-nf-work-556008108909-eu-west-2'}/work"

    params {
      // Results from Fargate runs
      outdir = "s3://${System.getenv('PP_DATA_BUCKET') ?: 'portable-precision-peterhds-eu2'}/results"
      // NOTE: path *values* for reads/reference/truth can still be overridden
      //       via -params-file when you want to point at real GIAB on S3.
    }

    //
    // Default process settings when this profile is active
    //
    process {
      executor  = 'awsbatch'
      queue     = 'pp-queue-fg'
      container = 'ubuntu:22.04'
      cpus      = 1
      memory    = '2 GB'
      shell     = ['/bin/bash','-ue']
      // No beforeScript: Wave + Fargate handle S3 I/O
    }

    //
    // AWS + Fargate wiring
    //
    aws {
      // Pick up region from env, fall back to eu-west-2
      region = System.getenv('PP_AWS_REGION') ?: 'eu-west-2'

      batch {
        // Tell Nextflow this is a Fargate CE
        platformType = 'fargate'

        // Job + execution roles â€“ taken from environment variables
        jobRole       = System.getenv('BATCH_JOB_ROLE_ARN')
        executionRole = System.getenv('BATCH_EXEC_ROLE_ARN')
      }
    }

    //
    // Wave: required for Fargate so Nextflow can use S3 transparently
    //
    wave {
      enabled = true
    }
  }
}
